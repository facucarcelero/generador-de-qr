<!DOCTYPE html>
<html lang="es">
<head>
        <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- V5 - SOLUCI√ìN DEFINITIVA: Eliminar redirecciones de Netlify -->
    <title>Generador de QR - Los Nogales - V46</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="QR Generator">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="Genera c√≥digos QR personalizables y din√°micos con enlaces modificables">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="/Logo/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/Logo/android-chrome-192x192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/Logo/android-chrome-512x512.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/Logo/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/Logo/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/Logo/favicon-16x16.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- QR Code library -->
    <script src="qr-stats.js"></script>
    <script>
        // V4 - SOLUCI√ìN DEFINITIVA: Cargar biblioteca QRCode
        async function loadQRCodeLibrary() {
            return new Promise(async (resolve, reject) => {
                console.log('üîç V4 - Intentando cargar biblioteca QRCode desde archivo local...');
                
                // Verificar si el archivo local est√° disponible
                const isAvailable = await checkLocalFile('qrcode.min.js');
                if (!isAvailable) {
                    console.error('‚ùå Archivo local qrcode.min.js no encontrado');
                    hideLibraryLoading();
                    showGeneratedQR(); // Mostrar el QR generado
                    reject(new Error('No se pudo cargar la biblioteca QRCode. El archivo local qrcode.min.js no est√° disponible.'));
                    return;
                }
                
                console.log('‚úÖ V4 - Archivo local encontrado, cargando biblioteca...');
                
                const script = document.createElement('script');
                script.src = 'qrcode.min.js';
                script.async = true;
                
                const timeout = setTimeout(() => {
                    console.error('‚ùå V4 - Timeout cargando biblioteca local');
                    script.onerror();
                }, 10000); // 10 segundos para archivo local
                
                script.onload = () => {
                    clearTimeout(timeout);
                    // Verificar si QRCode se carg√≥ correctamente
                    if (typeof QRCode !== 'undefined' && typeof QRCode.toCanvas === 'function') {
                        console.log('‚úÖ V4 - QRCode library loaded successfully from local file');
                        hideLibraryLoading();
                        showGeneratedQR(); // Mostrar el QR generado
                        resolve();
                    } else {
                        console.error('‚ùå V4 - QRCode loaded but toCanvas method not available');
                        hideLibraryLoading();
                        reject(new Error('La biblioteca QRCode se carg√≥ pero no tiene el m√©todo toCanvas necesario.'));
                    }
                };
                
                script.onerror = () => {
                    clearTimeout(timeout);
                    console.error('‚ùå V4 - Failed to load local QRCode library');
                    hideLibraryLoading();
                    showGeneratedQR(); // Mostrar el QR generado
                    reject(new Error('No se pudo cargar la biblioteca QRCode desde el archivo local.'));
                };
                
                // Mostrar indicador de carga
                showLibraryLoading();
                document.head.appendChild(script);
            });
        }

        // Funci√≥n para verificar si el archivo local est√° disponible
        function checkLocalFile(url) {
            return new Promise((resolve) => {
                console.log(`üîç Verificando disponibilidad de: ${url}`);
                const xhr = new XMLHttpRequest();
                xhr.open('HEAD', url, true);
                xhr.timeout = 5000; // Aumentar timeout a 5 segundos
                
                xhr.onload = () => {
                    const isAvailable = xhr.status === 200;
                    console.log(`üìÅ Archivo ${url}: ${isAvailable ? '‚úÖ Disponible' : '‚ùå No disponible'} (Status: ${xhr.status})`);
                    resolve(isAvailable);
                };
                
                xhr.onerror = () => {
                    console.log(`‚ùå Error verificando archivo: ${url}`);
                    resolve(false);
                };
                
                xhr.ontimeout = () => {
                    console.log(`‚è∞ Timeout verificando archivo: ${url}`);
                    resolve(false);
                };
                
                xhr.send();
            });
        }

        // Funci√≥n para mostrar mensaje de error m√°s amigable
        function showLibraryError(message = 'Error al cargar la biblioteca QRCode') {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #fee2e2;
                border: 1px solid #fecaca;
                border-radius: 8px;
                padding: 20px;
                max-width: 500px;
                z-index: 10000;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            
            errorDiv.innerHTML = `
                <h3 style="color: #dc2626; margin: 0 0 10px 0;">‚ùå Error de Carga</h3>
                <p style="margin: 0 0 15px 0; color: #374151;">${message}</p>
                <p style="margin: 0 0 15px 0; color: #6b7280; font-size: 14px;">
                    <strong>Posibles soluciones:</strong><br>
                    1. Verifica que el archivo qrcode.min.js est√© en la misma carpeta<br>
                    2. Recarga la p√°gina (Ctrl+F5)<br>
                    3. Limpia el cach√© del navegador
                </p>
                <button onclick="location.reload()" style="
                    background: #dc2626;
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 14px;
                ">üîÑ Recargar P√°gina</button>
                        `;
            document.body.appendChild(errorDiv);
        }

        // Mostrar indicador de carga
        function showLibraryLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'library-loading';
            loadingDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #ffffff;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 20px;
                text-align: center;
                z-index: 10000;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            `;
            loadingDiv.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <div style="width: 30px; height: 30px; border: 3px solid #f3f4f6; border-top: 3px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                </div>
                <p style="color: #374151; margin: 0;">Cargando biblioteca QRCode...</p>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLibraryLoading() {
            try {
                // Buscar por ID
                const loadingDiv = document.getElementById('library-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                    console.log('‚úÖ Indicador de carga removido por ID');
                    return;
                }
                
                // Buscar por clase
                const loadingElements = document.querySelectorAll('.loading');
                loadingElements.forEach(el => {
                    if (el.textContent.includes('Cargando biblioteca')) {
                        el.remove();
                        console.log('‚úÖ Indicador de carga removido por clase');
                    }
                });
                
                // Buscar por texto
                const allElements = document.querySelectorAll('*');
                allElements.forEach(el => {
                    if (el.textContent && el.textContent.includes('Cargando biblioteca QR')) {
                        el.remove();
                        console.log('‚úÖ Indicador de carga removido por texto');
                    }
                });
                
            } catch (error) {
                console.error('Error al ocultar indicador de carga:', error);
            }
        }

        function showGeneratedQR() {
            try {
                // Buscar el canvas generado y mostrarlo
                const canvases = document.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    if (canvas.style.display === 'none') {
                        canvas.style.display = 'block';
                        console.log('‚úÖ Canvas QR mostrado');
                    }
                });
                
                // Actualizar el √°rea de preview
                const previewArea = document.querySelector('.preview-section');
                if (previewArea) {
                    const placeholder = previewArea.querySelector('p');
                    if (placeholder && placeholder.textContent.includes('Ingresa una URL')) {
                        placeholder.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error al mostrar QR generado:', error);
            }
        }

                        // La biblioteca se cargar√° cuando el DOM est√© listo
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #1f2937;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(229, 231, 235, 0.5);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 700;
            font-size: 1.25rem;
            color: #1f2937;
            text-decoration: none;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .header-btn {
            width: 44px;
            height: 44px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header-btn:hover {
            background: #f9fafb;
            border-color: #10b981;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .storage-status {
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .storage-status:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .storage-status.available {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(34, 197, 94, 0.1) 100%);
            color: #166534;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .storage-status.available:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3) 0%, rgba(34, 197, 94, 0.2) 100%);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .storage-status.unavailable {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .storage-status.unavailable:hover {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(239, 68, 68, 0.2) 100%);
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2.5rem;
            align-items: start;
        }

        /* Form Section */
        .form-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: #1f2937;
            position: relative;
            padding-bottom: 0.5rem;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #374151;
            font-size: 1rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            transform: translateY(-1px);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .color-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .color-input {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .color-input-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
        }

        .color-input-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .color-input input[type="color"] {
            width: 60px;
            height: 50px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .color-input input[type="color"]:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .color-code-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            text-transform: uppercase;
            font-weight: 600;
            background: white;
        }

        .color-code-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Estilos para controles de quiet zone */
        .quiet-zone-controls {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .quiet-zone-option {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .quiet-zone-input-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
            color: #374151;
            font-size: 1rem;
        }

        .quiet-zone-size-control {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .quiet-zone-slider {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            outline: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quiet-zone-slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
        }

        .quiet-zone-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .quiet-zone-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        #quietZoneSizeValue {
            font-weight: 700;
            color: #10b981;
            min-width: 60px;
            text-align: center;
            font-size: 1.1rem;
            padding: 0.5rem;
            background: white;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .file-upload {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .file-upload:hover {
            border-color: #10b981;
            background: #f0fdf4;
            transform: translateY(-2px);
        }

        .file-upload input {
            display: none;
        }

        .logo-preview {
            max-width: 120px;
            max-height: 120px;
            margin-top: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #10b981;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2.5rem;
            flex-wrap: wrap;
        }

        /* QR Preview Section */
        .qr-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: sticky;
            top: 100px;
        }

        .qr-section:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .qr-container {
            margin: 2rem 0;
            padding: 2.5rem;
            background: white;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            display: inline-block;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .qr-container:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .qr-info {
            margin-top: 2rem;
            text-align: left;
            padding: 1.5rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .qr-info h3 {
            color: #10b981;
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .qr-info p {
            margin-bottom: 0.75rem;
            color: #6b7280;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* Saved QRs Section */
        .saved-qrs {
            grid-column: 1 / -1;
            margin-top: 4rem;
        }

        .saved-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .filter-btn:hover {
            border-color: #10b981;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .qr-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
            border-radius: 16px;
            padding: 2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .qr-card:hover {
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            transform: translateY(-4px);
        }

        .qr-card img {
            max-width: 180px;
            height: auto;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .qr-card h4 {
            color: #1f2937;
            margin-bottom: 0.75rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .qr-card p {
            color: #6b7280;
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
            word-break: break-all;
            line-height: 1.5;
        }

        .qr-type-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.75rem;
        }

        .qr-type-badge.dynamic {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .qr-type-badge.static {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .qr-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 0.75rem 1.25rem;
            font-size: 0.9rem;
        }

        /* Messages */
        .message {
            padding: 1.25rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            display: none;
            border: 1px solid;
            font-weight: 500;
        }

        .message.success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .message.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            color: #dc2626;
            border-color: rgba(239, 68, 68, 0.3);
        }

        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.75rem;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        /* Responsive Design - Mejorado */
        @media (max-width: 1200px) {
            .main-container {
                max-width: 1000px;
                gap: 2rem;
                padding: 1.5rem;
            }
        }

        @media (max-width: 1000px) {
            .main-container {
                max-width: 900px;
                gap: 2rem;
                padding: 1.5rem;
            }
            
            .qr-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 2rem;
                padding: 1.5rem;
            }

            .qr-section {
                position: static;
                order: -1;
            }

            .qr-grid {
                grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
                gap: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                padding: 0 0.5rem;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .main-container {
                padding: 1rem;
                gap: 1.5rem;
            }

            .form-section, .qr-section {
                padding: 1.5rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .color-inputs {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .color-input {
                padding: 1.25rem;
            }

            .quiet-zone-controls {
                padding: 1.25rem;
            }

            .button-group {
                flex-direction: column;
                gap: 1rem;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .qr-container {
                padding: 1.5rem;
            }

            .qr-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .saved-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .filter-buttons {
                justify-content: center;
                flex-wrap: wrap;
            }

            .qr-actions {
                justify-content: center;
                flex-wrap: wrap;
            }
        }

        @media (max-width: 600px) {
            .main-container {
                padding: 0.75rem;
                gap: 1rem;
            }

            .form-section, .qr-section {
                padding: 1rem;
                border-radius: 12px;
            }

            .section-title {
                font-size: 1.25rem;
            }

            .input-group {
                margin-bottom: 1rem;
            }

            .input-group label {
                font-size: 0.9rem;
            }

            .input-group input,
            .input-group textarea,
            .input-group select {
                padding: 0.75rem;
                font-size: 0.9rem;
            }

            .color-input {
                padding: 1rem;
            }

            .quiet-zone-controls {
                padding: 1rem;
            }

            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .qr-container {
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                padding: 0 0.25rem;
            }

            .logo {
                font-size: 1rem;
            }

            .logo-icon {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }

            .header-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }

            .main-container {
                padding: 0.5rem;
                gap: 0.75rem;
            }

            .form-section, .qr-section {
                padding: 0.75rem;
                border-radius: 8px;
            }

            .section-title {
                font-size: 1.1rem;
            }

            .input-group input,
            .input-group textarea,
            .input-group select {
                padding: 0.5rem;
                font-size: 0.85rem;
            }

            .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }

            .color-input {
                padding: 0.75rem;
            }

            .quiet-zone-controls {
                padding: 0.75rem;
            }
        }

        /* Mejoras de accesibilidad */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Modo oscuro (opcional) */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
                color: #f9fafb;
            }

            .header {
                background: rgba(31, 41, 55, 0.95);
                border-bottom-color: rgba(75, 85, 99, 0.5);
            }

            .form-section, .qr-section, .qr-card {
                background: rgba(31, 41, 55, 0.9);
                border-color: rgba(75, 85, 99, 0.5);
            }

            .form-input, .form-select, .form-textarea {
                background: #374151;
                border-color: #4b5563;
                color: #f9fafb;
            }

            .color-input, .quiet-zone-controls {
                background: #374151;
                border-color: #4b5563;
            }
        }

        /* Men√∫ m√≥vil */
        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .mobile-menu.active {
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
        }

        .mobile-menu-content {
            background: white;
            width: 300px;
            height: 100%;
            padding: 2rem;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.3);
            animation: slideInRight 0.3s ease;
            overflow-y: auto;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }

        .mobile-menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .mobile-menu-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .mobile-menu-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .mobile-menu-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .mobile-menu-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .mobile-menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: none;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 1rem;
            color: #374151;
            font-weight: 500;
        }

        .mobile-menu-item:hover {
            background: #f8fafc;
            transform: translateX(5px);
        }

        .mobile-menu-item span:first-child {
            font-size: 1.25rem;
            min-width: 30px;
        }

        /* Bot√≥n de scroll to top */
        .scroll-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .scroll-to-top:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .scroll-to-top.show {
            display: flex;
        }

        /* Mejoras para pantallas muy peque√±as */
        @media (max-width: 360px) {
            .mobile-menu-content {
                width: 100%;
                padding: 1.5rem;
            }

            .mobile-menu-item {
                padding: 0.875rem;
                font-size: 0.95rem;
            }

            .scroll-to-top {
                bottom: 1rem;
                right: 1rem;
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Script inmediato para forzar correcci√≥n de problemas de carga -->
    <script>
        // Forzar eliminaci√≥n inmediata del indicador de carga
        (function() {
            function forceCleanup() {
                // Solo eliminar elementos espec√≠ficos de carga
                const libraryLoading = document.getElementById('library-loading');
                if (libraryLoading) {
                    libraryLoading.remove();
                    console.log('üßπ Indicador de carga removido');
                }
                
                // Buscar elementos con clase 'loading' que contengan texto espec√≠fico
                const loadingElements = document.querySelectorAll('.loading');
                loadingElements.forEach(el => {
                    if (el.textContent && el.textContent.includes('Cargando biblioteca')) {
                        el.remove();
                        console.log('üßπ Elemento de carga removido por clase');
                    }
                });
                
                // Corregir fondo azul solo si es necesario
                if (document.body && document.body.style.background === 'blue') {
                    document.body.style.background = 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)';
                    console.log('üé® Fondo corregido');
                }
                
                // Forzar correcci√≥n del fondo azul de manera m√°s agresiva
                if (document.body) {
                    document.body.style.background = 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)';
                    document.body.style.backgroundColor = 'transparent';
                }
                if (document.documentElement) {
                    document.documentElement.style.background = 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)';
                    document.documentElement.style.backgroundColor = 'transparent';
                }
                
                // Asegurar que el HTML tambi√©n tenga el fondo correcto
                if (document.documentElement) {
                    document.documentElement.style.cssText += '; background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;';
                }
                
                // Mostrar el contenido principal si est√° oculto
                const mainContent = document.querySelector('.main-container');
                if (mainContent && mainContent.style.display === 'none') {
                    mainContent.style.display = 'block';
                    console.log('üì± Contenido principal mostrado');
                }
                
                // Mostrar canvases QR si est√°n ocultos
                const canvases = document.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    if (canvas.style.display === 'none' && canvas.width > 0) {
                        canvas.style.display = 'block';
                        console.log('üîç Canvas QR mostrado');
                    }
                });
            }
            
            // Ejecutar inmediatamente
            forceCleanup();
            
            // Y tambi√©n despu√©s de que el DOM est√© listo
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', forceCleanup);
            } else {
                forceCleanup();
            }
            
            // Y tambi√©n despu√©s de un timeout
            setTimeout(forceCleanup, 100);
            setTimeout(forceCleanup, 500);
        })();
    </script>

    <!-- V4 - SOLUCI√ìN DEFINITIVA: P√°gina principal SIN REDIRECCIONES -->
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">QR</div>
                <span>Generador de C√≥digos QR</span>
            </div>
            <div class="header-actions">
                <div id="storageStatus" class="storage-status"></div>
                <button class="header-btn" title="Informaci√≥n del almacenamiento" onclick="showStorageInfo()">üìä</button>
                <button class="header-btn" title="Limpiar almacenamiento" onclick="clearStorage()">üóëÔ∏è</button>
                <button class="header-btn" title="Ayuda" onclick="showHelp()">?</button>
                <button class="header-btn mobile-menu-btn" title="Men√∫" onclick="toggleMobileMenu()">‚ò∞</button>
            </div>
        </div>
        
        <!-- Men√∫ m√≥vil -->
        <div class="mobile-menu" id="mobileMenu">
            <div class="mobile-menu-content">
                <div class="mobile-menu-header">
                    <h3>Men√∫</h3>
                    <button class="mobile-menu-close" onclick="toggleMobileMenu()">‚úï</button>
                </div>
                <div class="mobile-menu-items">
                    <button class="mobile-menu-item" onclick="showStorageInfo(); toggleMobileMenu();">
                        <span>üìä</span>
                        <span>Informaci√≥n del almacenamiento</span>
                    </button>
                    <button class="mobile-menu-item" onclick="clearStorage(); toggleMobileMenu();">
                        <span>üóëÔ∏è</span>
                        <span>Limpiar almacenamiento</span>
                    </button>
                    <button class="mobile-menu-item" onclick="showHelp(); toggleMobileMenu();">
                        <span>?</span>
                        <span>Ayuda</span>
                    </button>
                    <button class="mobile-menu-item" onclick="scrollToTop(); toggleMobileMenu();">
                        <span>‚¨ÜÔ∏è</span>
                        <span>Ir al inicio</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Form Section -->
        <div class="form-section">
            <h2 class="section-title">Configuraci√≥n del QR</h2>
            
            <div class="form-group">
                <label class="form-label" for="qrType">Tipo de QR</label>
                <select class="form-select" id="qrType" onchange="toggleUrlInput()">
                    <option value="static">QR Est√°tico (enlace fijo)</option>
                    <option value="dynamic">QR Din√°mico (enlace modificable)</option>
                </select>
            </div>

            <div class="form-group" id="urlInputGroup">
                <label class="form-label" for="qrUrl">URL o Enlace *</label>
                <input type="url" class="form-input" id="qrUrl" placeholder="https://ejemplo.com" required>
                <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                    Para QRs din√°micos, este enlace se puede cambiar despu√©s sin regenerar el c√≥digo
                </small>
            </div>

            <div class="form-group">
                <label class="form-label" for="qrTitle">Nombre del QR</label>
                <input type="text" class="form-input" id="qrTitle" placeholder="Mi c√≥digo QR personalizado">
            </div>

            <div class="form-group">
                <label class="form-label" for="qrDescription">Descripci√≥n</label>
                <textarea class="form-textarea" id="qrDescription" rows="3" placeholder="Descripci√≥n opcional del c√≥digo QR"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Colores del QR</label>
                <div class="color-inputs">
                    <div class="color-input">
                        <label class="color-input-header">üé® Color Principal (QR)</label>
                        <div class="color-input-row">
                            <input type="color" id="foregroundColor" value="#000000">
                            <input type="text" class="color-code-input" id="foregroundHex" value="#000000" placeholder="#000000">
                        </div>
                    </div>
                    <div class="color-input">
                        <label class="color-input-header">üñºÔ∏è Color Secundario (Fondo)</label>
                        <div class="color-input-row">
                            <input type="color" id="backgroundColor" value="#FFFFFF">
                            <input type="text" class="color-code-input" id="backgroundColorHex" value="#FFFFFF" placeholder="#FFFFFF">
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Espacio alrededor del QR</label>
                <div class="quiet-zone-controls">
                    <div class="quiet-zone-option">
                        <label class="quiet-zone-input-header">üìè Tama√±o del Espacio</label>
                                                                <div class="quiet-zone-size-control">
                                            <input type="range" id="quietZoneSize" min="0" max="100" value="0" class="quiet-zone-slider">
                                            <span id="quietZoneSizeValue">0px</span>
                                        </div>
                                                                <small style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                                            Controla el espacio alrededor del c√≥digo QR. En 0px el QR llena todo el canvas
                                        </small>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="qrSize">Tama√±o del QR</label>
                <select class="form-select" id="qrSize">
                    <option value="200">Peque√±o (200px)</option>
                    <option value="300" selected>Mediano (300px)</option>
                    <option value="400">Grande (400px)</option>
                    <option value="500">Extra grande (500px)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="errorCorrection">Nivel de correcci√≥n de errores</label>
                <select class="form-select" id="errorCorrection">
                    <option value="L">Bajo (7%)</option>
                    <option value="M" selected>Medio (15%)</option>
                    <option value="Q">Alto (25%)</option>
                    <option value="H">M√°ximo (30%)</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Logo personalizado (opcional)</label>
                <div class="file-upload" onclick="document.getElementById('logoFile').click()">
                    <input type="file" id="logoFile" accept="image/*">
                    <div>üìÅ Seleccionar imagen</div>
                    <small style="color: #6b7280;">Haz clic para subir tu logo</small>
                </div>
                <img id="logoPreview" class="logo-preview" style="display: none;">
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="generateQR()">
                    üîÑ Generar QR
                </button>
                <button class="btn btn-secondary" onclick="regenerateQR()" id="regenerateBtn" style="display: none;">
                    üîÑ Regenerar QR
                </button>
                <button class="btn btn-secondary" onclick="saveChanges()" id="saveChangesBtn" style="display: none;">
                    üíæ Guardar Cambios
                </button>
                <button class="btn btn-secondary" onclick="downloadQR()">
                    üíæ Descargar
                </button>
                <button class="btn btn-secondary" onclick="saveQR()">
                    üíæ Guardar QR
                </button>
            </div>

            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 1rem; margin: 1rem 0; font-size: 0.9rem; color: #0c4a6e;">
                <strong>üí° Nueva funcionalidad:</strong> Una vez generado el QR, este se mantiene completamente fijo. Puedes modificar colores, tama√±o, margen y URL sin que el QR se regenere. Usa "Guardar Cambios" para guardar las modificaciones o "Regenerar QR" para crear un nuevo c√≥digo.
            </div>

            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Generando c√≥digo QR...</p>
            </div>

            <div id="successMessage" class="message success"></div>
            <div id="errorMessage" class="message error"></div>
        </div>

        <!-- QR Preview Section -->
        <div class="qr-section">
            <h2 class="section-title">Vista Previa</h2>
            <div id="qrContainer" class="qr-container">
                <p style="color: #6b7280;">Ingresa una URL para generar el c√≥digo QR</p>
            </div>
            
            <div id="qrInfo" class="qr-info" style="display: none;">
                <h3>Informaci√≥n del QR</h3>
                <p><strong>URL:</strong> <span id="currentUrl"></span></p>
                <p><strong>Nombre:</strong> <span id="currentTitle"></span></p>
                <p><strong>Tama√±o:</strong> <span id="currentSize"></span></p>
                <p><strong>Generado:</strong> <span id="currentDate"></span></p>
            </div>
        </div>
    </div>

    <!-- Saved QRs Section -->
    <div class="saved-qrs">
        <div class="saved-header">
            <h2 class="section-title">Mis C√≥digos QR Guardados</h2>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterQRs('all')" id="filterAll">Todos</button>
                <button class="filter-btn" onclick="filterQRs('static')" id="filterStatic">Est√°ticos</button>
                <button class="filter-btn" onclick="filterQRs('dynamic')" id="filterDynamic">Din√°micos</button>
            </div>
        </div>
        
        <div id="savedQrsGrid" class="qr-grid">
            <!-- Los QRs guardados se mostrar√°n aqu√≠ -->
        </div>
    </div>

    <!-- Modal for Dynamic QR Management -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Gestionar QR Din√°mico</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="newUrl">Nueva URL de destino</label>
                <input type="url" class="form-input" id="newUrl" placeholder="https://ejemplo.com">
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="updateDynamicQR()">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Bot√≥n de scroll to top -->
    <button class="scroll-to-top" id="scrollToTop" onclick="scrollToTop()" title="Ir al inicio">‚¨ÜÔ∏è</button>

    <!-- Loading indicator -->
    <div id="library-loading" class="loading">
        <div class="spinner"></div>
        <p>Cargando biblioteca QR...</p>
    </div>

    <!-- Messages -->
    <div id="message" class="message"></div>

    <!-- Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Modal</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let currentQRData = null;
        let savedQRs = JSON.parse(localStorage.getItem('savedQRs') || '[]');
        let currentEditingQRId = null;

        // Funciones robustas para localStorage en m√≥viles
        function isLocalStorageAvailable() {
            try {
                const test = '__localStorage_test__';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                console.warn('localStorage no disponible:', e);
                return false;
            }
        }

        function safeSetItem(key, value) {
            try {
                if (!isLocalStorageAvailable()) {
                    console.warn('localStorage no disponible, usando fallback');
                    return false;
                }
                
                // Verificar si el valor es demasiado grande
                const valueSize = JSON.stringify(value).length;
                const maxSize = 5 * 1024 * 1024; // 5MB l√≠mite
                
                if (valueSize > maxSize) {
                    console.warn(`Datos demasiado grandes (${valueSize} bytes), intentando comprimir`);
                    // Intentar comprimir eliminando datos innecesarios
                    if (value && Array.isArray(value)) {
                        value = value.map(qr => ({
                            id: qr.id,
                            name: qr.name,
                            type: qr.type,
                            originalUrl: qr.originalUrl,
                            url: qr.url,
                            timestamp: qr.timestamp,
                            // Reducir calidad de imagen para ahorrar espacio
                            imageData: qr.imageData ? qr.imageData.split(',')[0] + ',' + qr.imageData.split(',')[1].substring(0, 1000) + '...' : null,
                            size: qr.size,
                            colors: qr.colors,
                            errorCorrection: qr.errorCorrection
                        }));
                    }
                }
                
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                console.error('Error al guardar en localStorage:', e);
                
                // Intentar limpiar localStorage si est√° lleno
                if (e.name === 'QuotaExceededError' || e.code === 22) {
                    console.log('localStorage lleno, intentando limpiar datos antiguos');
                    try {
                        // Eliminar datos m√°s antiguos
                        const savedQRs = JSON.parse(localStorage.getItem('savedQRs') || '[]');
                        if (savedQRs.length > 10) {
                            // Mantener solo los 10 m√°s recientes
                            const sortedQRs = savedQRs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            const trimmedQRs = sortedQRs.slice(0, 10);
                            localStorage.setItem('savedQRs', JSON.stringify(trimmedQRs));
                            console.log('Datos antiguos eliminados, intentando guardar nuevamente');
                            
                            // Intentar guardar nuevamente
                            return safeSetItem(key, value);
                        }
                    } catch (cleanupError) {
                        console.error('Error al limpiar localStorage:', cleanupError);
                    }
                }
                
                return false;
            }
        }

        function safeGetItem(key, defaultValue = null) {
            try {
                if (!isLocalStorageAvailable()) {
                    console.warn('localStorage no disponible, usando valor por defecto');
                    return defaultValue;
                }
                
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error('Error al leer de localStorage:', e);
                return defaultValue;
            }
        }

        function showStorageStatus() {
            const isAvailable = isLocalStorageAvailable();
            const statusElement = document.getElementById('storageStatus');
            
            if (statusElement) {
                if (isAvailable) {
                    statusElement.textContent = '‚úÖ Almacenamiento disponible';
                    statusElement.className = 'storage-status available';
                    statusElement.title = 'El almacenamiento local est√° funcionando correctamente. Haz clic para m√°s informaci√≥n.';
                    statusElement.style.cursor = 'pointer';
                    statusElement.onclick = showStorageInfo;
                } else {
                    statusElement.textContent = '‚ö†Ô∏è Almacenamiento no disponible';
                    statusElement.className = 'storage-status unavailable';
                    statusElement.title = 'El almacenamiento local no est√° disponible. Los datos no se guardar√°n. Haz clic para m√°s informaci√≥n.';
                    statusElement.style.cursor = 'pointer';
                    statusElement.onclick = showStorageInfo;
                }
            }
        }

        function clearStorage() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todos los datos guardados? Esta acci√≥n no se puede deshacer.')) {
                try {
                    localStorage.clear();
                    showMessage('Almacenamiento limpiado correctamente', 'success');
                    loadSavedQRs();
                    showStorageStatus();
                } catch (e) {
                    console.error('Error al limpiar almacenamiento:', e);
                    showMessage('Error al limpiar el almacenamiento', 'error');
                }
            }
        }

        function showStorageInfo() {
            try {
                const savedQRs = safeGetItem('savedQRs', []);
                const totalSize = JSON.stringify(savedQRs).length;
                const maxSize = 5 * 1024 * 1024; // 5MB
                const usagePercent = (totalSize / maxSize) * 100;
                
                const info = `
                    üìä Informaci√≥n del Almacenamiento:
                    
                    ‚Ä¢ QRs guardados: ${savedQRs.length}
                    ‚Ä¢ Espacio usado: ${(totalSize / 1024).toFixed(1)} KB
                    ‚Ä¢ Espacio disponible: ${((maxSize - totalSize) / 1024 / 1024).toFixed(1)} MB
                    ‚Ä¢ Uso: ${usagePercent.toFixed(1)}%
                    ‚Ä¢ Estado: ${isLocalStorageAvailable() ? '‚úÖ Disponible' : '‚ùå No disponible'}
                `;
                
                alert(info);
            } catch (e) {
                console.error('Error al obtener informaci√≥n del almacenamiento:', e);
                showMessage('Error al obtener informaci√≥n del almacenamiento', 'error');
            }
        }

        // Funci√≥n para verificar que todo est√© listo
        function initializeApp() {
            // Verificar si QRCode est√° disponible
            if (typeof QRCode === 'undefined') {
                console.error('QRCode library not loaded');
                showMessage('Error: No se pudo cargar la biblioteca QRCode. Verifica tu conexi√≥n a internet y recarga la p√°gina.', 'error');
                return false;
            }
            
            // Verificar que el m√©todo toCanvas est√© disponible
            if (typeof QRCode.toCanvas !== 'function') {
                console.error('QRCode.toCanvas method not available');
                showMessage('Error: La biblioteca QRCode no tiene el m√©todo toCanvas. Verifica tu conexi√≥n a internet y recarga la p√°gina.', 'error');
                return false;
            }
            
            // Verificar estado de almacenamiento
            showStorageStatus();
            
            console.log('QRCode library loaded successfully with toCanvas method');
            return true;
        }

        // Inicializar cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM cargado, inicializando aplicaci√≥n completa...');
            
            // Cargar la biblioteca QRCode primero
            loadQRCodeLibrary()
                .then(() => {
                    console.log('QRCode library loaded successfully');
                    
                    // Inicializar la aplicaci√≥n despu√©s de cargar la biblioteca
                    initializeApplication();
                })
                .catch((error) => {
                    console.error('Error cargando biblioteca QRCode:', error);
                    showLibraryError(error.message);
                });
        });

        // Funci√≥n para inicializar toda la aplicaci√≥n
        function initializeApplication() {
            console.log('Inicializando aplicaci√≥n...');
            
            // Inicializar color pickers
            initializeColorPickers();
            
            // Inicializar controles de quiet zone
            initializeQuietZoneControls();
            
            // Inicializar event listeners
            initializeEventListeners();
            
            // Cargar QRs guardados al iniciar
            loadSavedQRs();
            
            // Comentado: No probar generaci√≥n autom√°ticamente para evitar regeneraci√≥n
            // setTimeout(() => {
            //     testQRGeneration();
            // }, 500);
            
            // Agregar event listeners para mejoras de UX
            window.addEventListener('scroll', handleScroll);
            document.addEventListener('click', handleClickOutside);
            document.addEventListener('keydown', handleKeyDown);
            
            // Agregar soporte t√°ctil
            addTouchSupport();
            
            // Optimizar para m√≥viles
            optimizeForMobile();
            
            // Cerrar men√∫ m√≥vil al cambiar orientaci√≥n
            window.addEventListener('orientationchange', function() {
                setTimeout(() => {
                    const mobileMenu = document.getElementById('mobileMenu');
                    if (mobileMenu && mobileMenu.classList.contains('active')) {
                        toggleMobileMenu();
                    }
                }, 100);
            });
            
            // Cerrar modal al hacer clic fuera
            const modal = document.getElementById('modal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal();
                    }
                });
            }
            
            console.log('Aplicaci√≥n inicializada correctamente');
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('/sw.js')
                        .then(function(registration) {
                            console.log('Service Worker registrado exitosamente:', registration.scope);
                        })
                        .catch(function(error) {
                            console.log('Error al registrar Service Worker:', error);
                        });
                });
            }
            
            // Mostrar banner de instalaci√≥n PWA
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                
                // Mostrar bot√≥n de instalaci√≥n si no est√° ya instalado
                const installButton = document.createElement('button');
                installButton.textContent = 'üì± Instalar App';
                installButton.className = 'install-pwa-btn';
                installButton.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10b981;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    transition: all 0.3s ease;
                `;
                
                installButton.addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            console.log('Usuario acept√≥ instalar la app');
                        }
                        deferredPrompt = null;
                        installButton.remove();
                    }
                });
                
                document.body.appendChild(installButton);
            });
        }

        // Funci√≥n para inicializar event listeners
        function initializeEventListeners() {
            console.log('Inicializando event listeners...');
            
            // Event listeners para URL y nombre
            const qrUrlElement = document.getElementById('qrUrl');
            const qrNameElement = document.getElementById('qrTitle');
            
            if (qrUrlElement) {
                qrUrlElement.addEventListener('input', function() {
                    // Solo actualizar la URL en los datos, no regenerar QR
                    if (currentQRData) {
                        currentQRData.url = this.value.trim();
                        showQRInfo();
                        // Mostrar bot√≥n de guardar cambios
                        showPendingChanges();
                    }
                });
            } else {
                console.error('Elemento qrUrl no encontrado');
            }
            
            if (qrNameElement) {
                qrNameElement.addEventListener('input', function() {
                    // Solo actualizar el nombre, no regenerar QR
                    if (currentQRData) {
                        currentQRData.title = this.value.trim() || 'QR sin t√≠tulo';
                        showQRInfo();
                        // Mostrar bot√≥n de guardar cambios
                        showPendingChanges();
                    }
                });
            } else {
                console.error('Elemento qrTitle no encontrado');
            }
            
            // Event listeners para tama√±o y correcci√≥n de errores
            const qrSizeElement = document.getElementById('qrSize');
            const errorCorrectionElement = document.getElementById('errorCorrection');
            
            if (qrSizeElement) {
                qrSizeElement.addEventListener('change', function() {
                    console.log('Tama√±o cambiado a:', this.value);
                    // Actualizar tama√±o del QR existente en lugar de regenerar
                    if (currentQRData && currentQRData.qrText) {
                        updateQRSize();
                    }
                });
            } else {
                console.error('Elemento qrSize no encontrado');
            }
            
            if (errorCorrectionElement) {
                errorCorrectionElement.addEventListener('change', function() {
                    console.log('Correcci√≥n de errores cambiada a:', this.value);
                    // Solo actualizar el valor, no regenerar QR
                    if (currentQRData) {
                        currentQRData.errorCorrection = this.value;
                        // Mostrar bot√≥n de guardar cambios
                        showPendingChanges();
                    }
                });
            } else {
                console.error('Elemento errorCorrection no encontrado');
            }
            
            console.log('Event listeners inicializados');
        }

        // Funci√≥n para probar la generaci√≥n de QR
        function testQRGeneration() {
            try {
                console.log('Testing QR generation...');
                console.log('QRCode object:', typeof QRCode);
                console.log('QRCode.toCanvas method:', typeof QRCode.toCanvas);
                
                // Crear un canvas para la prueba
                const testCanvas = document.createElement('canvas');
                testCanvas.width = 100;
                testCanvas.height = 100;
                testCanvas.style.display = 'none';
                document.body.appendChild(testCanvas);
                
                // Usar la API correcta para QRCode 1.4.4
                QRCode.toCanvas(testCanvas, 'https://example.com', {
                    width: 100,
                    height: 100,
                    colorDark: '#000000',
                    colorLight: '#FFFFFF',
                    correctLevel: 1
                }, function(error, canvas) {
                    if (error) {
                        console.error('QR Test failed:', error);
                        // No mostrar mensaje de error al usuario, solo log
                        console.warn('QR test failed but continuing...');
                    } else {
                        console.log('QR Test successful - Canvas generated:', canvas);
                    }
                    document.body.removeChild(testCanvas);
                });
            } catch (error) {
                console.error('QR Test exception:', error);
                // No mostrar mensaje de error al usuario, solo log
                console.warn('QR test exception but continuing...');
            }
        }

        // Funci√≥n para obtener el nivel de correcci√≥n de errores
        function getErrorCorrectionLevel(level) {
            // Verificar si QRCode.CorrectLevel est√° disponible (versi√≥n 1.4.4)
            if (typeof QRCode !== 'undefined' && QRCode.CorrectLevel) {
                return QRCode.CorrectLevel[level];
            }
            
            // Valores por defecto para QRCode 1.4.4
            const levels = {
                'L': 0, // Low - 7%
                'M': 1, // Medium - 15%
                'Q': 2, // Quartile - 25%
                'H': 3  // High - 30%
            };
            
            return levels[level] || 1; // Default to Medium
        }

        // Configurar preview del logo
        document.getElementById('logoFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('logoPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        function generateQR() {
            const qrType = document.getElementById('qrType').value;
            const url = document.getElementById('qrUrl').value.trim();
            
            if (qrType === 'dynamic' && !url) {
                showMessage('Para QRs din√°micos, debes especificar una URL inicial', 'error');
                return;
            }

            // Si no hay URL, usar un texto de demostraci√≥n para mostrar los colores
            let qrText = url || 'https://ejemplo.com';
            let isDemo = !url;

            // Verificar si la biblioteca QRCode est√° disponible
            if (typeof QRCode === 'undefined') {
                showMessage('Error: La biblioteca QRCode no se carg√≥ correctamente. Por favor, recarga la p√°gina.', 'error');
                return;
            }

            // Verificar que el m√©todo toCanvas est√© disponible
            if (typeof QRCode.toCanvas !== 'function') {
                showMessage('Error: La biblioteca QRCode no tiene el m√©todo toCanvas. Por favor, recarga la p√°gina.', 'error');
                return;
            }

            showLoading(true);
            
            // Para QRs din√°micos, generar URL de redirecci√≥n
            if (qrType === 'dynamic' && !isDemo) {
                // Usar el ID del QR actual si existe (para edici√≥n), o generar uno nuevo
                // Para QR din√°micos, usar la URL directa del usuario con par√°metros de estad√≠sticas
                const idForDynamicQR = currentQRData && currentQRData.id ? currentQRData.id : generateId();
                const qrNameForDynamic = document.getElementById('qrTitle').value.trim() || 'QR Din√°mico';
                
                // Agregar par√°metros de estad√≠sticas a la URL
                qrText = addStatsParamsToUrl(url, idForDynamicQR, qrNameForDynamic);
                
                // Guardar informaci√≥n para estad√≠sticas (se usar√° internamente)
                const encodedUrl = btoa(encodeURIComponent(url));
                const encodedName = btoa(encodeURIComponent(qrNameForDynamic));
            }
            
            const options = {
                width: parseInt(document.getElementById('qrSize').value),
                height: parseInt(document.getElementById('qrSize').value),
                colorDark: document.getElementById('foregroundColor').value,
                colorLight: document.getElementById('backgroundColor').value,
                correctLevel: getErrorCorrectionLevel(document.getElementById('errorCorrection').value)
            };

            // Debug: Mostrar las opciones en consola
            console.log('QR Options:', options);
            console.log('QR Text:', qrText);
            console.log('QRCode library available:', typeof QRCode !== 'undefined');
            console.log('QRCode.toCanvas available:', typeof QRCode.toCanvas === 'function');

            // Limpiar contenedor anterior y crear canvas
            const container = document.getElementById('qrContainer');
            container.innerHTML = '';
            
            // Crear un canvas para el QR
            const canvas = document.createElement('canvas');
            canvas.width = options.width;
            canvas.height = options.height;
            container.appendChild(canvas);

            // Generar QR con manejo de errores mejorado
            try {
                console.log('Iniciando generaci√≥n de QR...');
                QRCode.toCanvas(canvas, qrText, options, function(error, generatedCanvas) {
                    showLoading(false);
                    
                    if (error) {
                        console.error('QR Generation error:', error);
                        showMessage('Error al generar el c√≥digo QR: ' + error.message, 'error');
                        return;
                    }

                    if (!generatedCanvas) {
                        console.error('No se gener√≥ el canvas del QR');
                        showMessage('Error: No se pudo generar el canvas del QR', 'error');
                        return;
                    }

                    console.log('QR generado exitosamente con colores:', {
                        foreground: options.colorDark,
                        background: options.colorLight
                    });

                    // Aplicar colores personalizados al canvas
                    colorizeQRCanvas(generatedCanvas, options.colorDark, options.colorLight);

                    // Aplicar quiet zone personalizado
                    const quietZoneSize = parseInt(document.getElementById('quietZoneSize').value);
                    if (quietZoneSize >= 0) {
                        applyQuietZoneToQR(generatedCanvas, quietZoneSize, options.colorLight);
                    }

                    // Agregar logo si existe
                    const logoFile = document.getElementById('logoFile').files[0];
                    if (logoFile) {
                        addLogoToQR(generatedCanvas, logoFile);
                    }

                    // Guardar datos del QR actual
                    currentQRData = {
                        url: url,
                        qrType: qrType,
                        title: document.getElementById('qrTitle').value || 'QR sin t√≠tulo',
                        description: document.getElementById('qrDescription').value || '',
                        size: options.width,
                        colors: {
                            foreground: options.colorDark,
                            background: options.colorLight
                        },
                        errorCorrection: document.getElementById('errorCorrection').value,
                        quietZoneSize: quietZoneSize,
                        qrText: qrText,
                        isDemo: isDemo,
                        timestamp: new Date().toISOString()
                    };

                    // Mostrar botones de acci√≥n
                    showActionButtons();
                    
                    // Mostrar informaci√≥n del QR
                    showQRInfo();
                    
                    // Mostrar bot√≥n de regenerar y ocultar bot√≥n de generar
                    document.getElementById('regenerateBtn').style.display = 'inline-flex';
                    document.querySelector('.btn-primary').style.display = 'none';
                    
                    // Ocultar bot√≥n de guardar cambios (no hay cambios pendientes en un QR nuevo)
                    document.getElementById('saveChangesBtn').style.display = 'none';
                    
                    showMessage('C√≥digo QR generado exitosamente', 'success');
                });
            } catch (error) {
                showLoading(false);
                console.error('QR Generation exception:', error);
                showMessage('Error inesperado al generar el c√≥digo QR: ' + error.message, 'error');
            }
        }

        // Funci√≥n para actualizar solo los colores del QR existente (sin regenerar)
        function updateQRColors() {
            if (!currentQRData || !currentQRData.qrText) {
                showMessage('Primero debes generar un QR', 'error');
                return;
            }

            const canvas = document.getElementById('qrContainer').querySelector('canvas');
            if (!canvas) {
                showMessage('No hay un QR generado para actualizar', 'error');
                return;
            }

            const newForegroundColor = document.getElementById('foregroundColor').value;
            const newBackgroundColor = document.getElementById('backgroundColor').value;

            // Aplicar nuevos colores al canvas existente
            colorizeQRCanvas(canvas, newForegroundColor, newBackgroundColor);

            // Aplicar quiet zone si es necesario
            const quietZoneSize = parseInt(document.getElementById('quietZoneSize').value);
            if (quietZoneSize >= 0) {
                applyQuietZoneToQR(canvas, quietZoneSize, newBackgroundColor);
            }

            // Actualizar datos del QR actual
            currentQRData.colors = {
                foreground: newForegroundColor,
                background: newBackgroundColor
            };
            currentQRData.quietZoneSize = quietZoneSize;

            // Mostrar bot√≥n de guardar cambios
            showPendingChanges();

            showMessage('Colores del QR actualizados', 'success');
        }

        // Funci√≥n para actualizar solo el tama√±o del QR existente (sin regenerar)
        function updateQRSize() {
            if (!currentQRData || !currentQRData.qrText) {
                showMessage('Primero debes generar un QR', 'error');
                return;
            }

            const newSize = parseInt(document.getElementById('qrSize').value);
            const container = document.getElementById('qrContainer');
            const existingCanvas = container.querySelector('canvas');
            
            if (!existingCanvas) {
                showMessage('No hay un QR generado para actualizar', 'error');
                return;
            }

            // Crear un nuevo canvas con el tama√±o actualizado
            const newCanvas = document.createElement('canvas');
            newCanvas.width = newSize;
            newCanvas.height = newSize;
            const ctx = newCanvas.getContext('2d');

            // Escalar el QR existente al nuevo tama√±o
            ctx.drawImage(existingCanvas, 0, 0, newSize, newSize);

            // Reemplazar el canvas anterior
            container.innerHTML = '';
            container.appendChild(newCanvas);

            // Actualizar datos del QR actual
            currentQRData.size = newSize;

            // Mostrar bot√≥n de guardar cambios
            showPendingChanges();

            showMessage('Tama√±o del QR actualizado', 'success');
        }

        // Funci√≥n para regenerar el QR completamente
        function regenerateQR() {
            // Limpiar datos actuales
            currentQRData = null;
            
            // Ocultar botones
            document.getElementById('regenerateBtn').style.display = 'none';
            document.getElementById('saveChangesBtn').style.display = 'none';
            
            // Mostrar bot√≥n de generar
            document.querySelector('.btn-primary').style.display = 'inline-flex';
            
            // Limpiar contenedor
            document.getElementById('qrContainer').innerHTML = '<p style="color: #6b7280;">Ingresa una URL para generar el c√≥digo QR</p>';
            
            // Ocultar informaci√≥n del QR
            document.getElementById('qrInfo').style.display = 'none';
            
            showMessage('Listo para generar un nuevo QR', 'success');
        }

        // Funci√≥n para guardar cambios del QR sin regenerarlo
        function saveChanges() {
            if (!currentQRData) {
                showMessage('No hay un QR para guardar cambios', 'error');
                return;
            }

            // Actualizar todos los datos del QR actual con los valores actuales del formulario
            currentQRData.url = document.getElementById('qrUrl').value.trim();
            currentQRData.title = document.getElementById('qrTitle').value.trim() || 'QR sin t√≠tulo';
            currentQRData.description = document.getElementById('qrDescription').value.trim();
            currentQRData.size = parseInt(document.getElementById('qrSize').value);
            currentQRData.colors = {
                foreground: document.getElementById('foregroundColor').value,
                background: document.getElementById('backgroundColor').value
            };
            currentQRData.errorCorrection = document.getElementById('errorCorrection').value;
            currentQRData.quietZoneSize = parseInt(document.getElementById('quietZoneSize').value);
            currentQRData.timestamp = new Date().toISOString();

            // Ocultar bot√≥n de guardar cambios
            document.getElementById('saveChangesBtn').style.display = 'none';

            // Actualizar informaci√≥n mostrada
            showQRInfo();

            showMessage('Cambios guardados exitosamente', 'success');
        }

        // Funci√≥n para mostrar que hay cambios pendientes
        function showPendingChanges() {
            if (currentQRData) {
                document.getElementById('saveChangesBtn').style.display = 'inline-flex';
            }
        }

        function addLogoToQR(canvas, logoFile) {
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                const logoSize = canvas.width * 0.2;
                const logoX = (canvas.width - logoSize) / 2;
                const logoY = (canvas.height - logoSize) / 2;
                
                // Dibujar fondo blanco para el logo
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(logoX - 5, logoY - 5, logoSize + 10, logoSize + 10);
                
                // Dibujar el logo
                ctx.drawImage(img, logoX, logoY, logoSize, logoSize);
            };
            
            img.src = URL.createObjectURL(logoFile);
        }

        // Funci√≥n para mostrar botones de acci√≥n
        function showActionButtons() {
            const regenerateBtn = document.getElementById('regenerateBtn');
            const saveChangesBtn = document.getElementById('saveChangesBtn');
            const generateBtn = document.querySelector('.btn-primary');
            
            if (regenerateBtn) regenerateBtn.style.display = 'inline-flex';
            if (generateBtn) generateBtn.style.display = 'none';
            if (saveChangesBtn) saveChangesBtn.style.display = 'none';
        }

        // Funci√≥n para mostrar informaci√≥n del QR
        function showQRInfo() {
            const qrInfo = document.getElementById('qrInfo');
            if (!qrInfo || !currentQRData) return;
            
            const url = currentQRData.url || 'Sin URL';
            const name = currentQRData.name || 'QR sin t√≠tulo';
            const size = currentQRData.size || 300;
            const timestamp = currentQRData.timestamp ? new Date(currentQRData.timestamp).toLocaleString() : new Date().toLocaleString();
            
            qrInfo.innerHTML = `
                <div class="qr-info-item">
                    <strong>URL:</strong> <span>${url}</span>
                </div>
                <div class="qr-info-item">
                    <strong>Nombre:</strong> <span>${name}</span>
                </div>
                <div class="qr-info-item">
                    <strong>Tama√±o:</strong> <span>${size}px</span>
                </div>
                <div class="qr-info-item">
                    <strong>Generado:</strong> <span>${timestamp}</span>
                </div>
            `;
        }

        function downloadQR() {
            if (!currentQRData) {
                showMessage('Primero genera un c√≥digo QR', 'error');
                return;
            }

            const canvas = document.querySelector('#qrContainer canvas');
            if (!canvas) {
                showMessage('No hay c√≥digo QR para descargar', 'error');
                return;
            }

            const link = document.createElement('a');
            link.download = `qr-${currentQRData.title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function addStatsParamsToUrl(url, qrId, qrName) {
            try {
                const urlObj = new URL(url);
                urlObj.searchParams.set('qr_id', qrId);
                urlObj.searchParams.set('qr_name', encodeURIComponent(qrName));
                return urlObj.toString();
            } catch (error) {
                // Si no es una URL v√°lida, agregar par√°metros al final
                const separator = url.includes('?') ? '&' : '?';
                return `${url}${separator}qr_id=${qrId}&qr_name=${encodeURIComponent(qrName)}`;
            }
        }

        function saveQR() {
            if (!currentQRData) {
                showMessage('Primero debes generar un c√≥digo QR', 'error');
                return;
            }

            const name = document.getElementById('qrTitle').value.trim();
            if (!name) {
                showMessage('Por favor ingresa un nombre para el c√≥digo QR', 'error');
                return;
            }

            const qrType = document.getElementById('qrType').value;
            let savedQRs = safeGetItem('savedQRs', []);
            const existingIndex = savedQRs.findIndex(qr => qr.name === name);

            // Obtener imagen del canvas de manera m√°s robusta
            let imageData = null;
            const qrContainer = document.getElementById('qrContainer');
            
            if (qrContainer) {
                const canvas = qrContainer.querySelector('canvas');
                if (canvas) {
                    try {
                        imageData = canvas.toDataURL('image/png');
                    } catch (error) {
                        console.error('Error al obtener imagen del QR:', error);
                    }
                } else {
                    // Si no hay canvas, buscar una imagen
                    const img = qrContainer.querySelector('img');
                    if (img && img.src) {
                        imageData = img.src;
                    }
                }
            }

            // Si no se pudo obtener la imagen, mostrar error
            if (!imageData) {
                showMessage('Error: No se pudo obtener la imagen del QR. Intenta regenerar el QR.', 'error');
                return;
            }

            const qrData = {
                id: existingIndex >= 0 ? savedQRs[existingIndex].id : generateId(),
                name: name,
                type: qrType,
                originalUrl: currentQRData.url, // Guardar la URL original
                timestamp: new Date().toISOString(),
                imageData: imageData,
                // Guardar configuraci√≥n para poder editar
                size: document.getElementById('qrSize').value,
                colors: {
                    foreground: document.getElementById('foregroundColor').value,
                    background: document.getElementById('backgroundColor').value
                },
                errorCorrection: document.getElementById('errorCorrection').value
            };

            // Para QRs din√°micos, crear una URL con par√°metros en lugar de usar localStorage
            if (qrType === 'dynamic') {
                // Codificar la URL en base64 para evitar problemas con caracteres especiales
                const encodedUrl = btoa(encodeURIComponent(currentQRData.url));
                const encodedName = btoa(encodeURIComponent(name));
                qrData.redirectUrl = currentQRData.url; // Usar la URL directa
                qrData.url = currentQRData.url; // Usar la URL original
                qrData.encodedUrl = encodedUrl; // Guardar para estad√≠sticas
                qrData.encodedName = encodedName; // Guardar para estad√≠sticas
            } else {
                qrData.url = currentQRData.url; // Para QRs est√°ticos, usar la URL original
            }

            if (existingIndex >= 0) {
                savedQRs[existingIndex] = qrData;
                showMessage('C√≥digo QR actualizado correctamente', 'success');
            } else {
                savedQRs.push(qrData);
                showMessage('C√≥digo QR guardado correctamente', 'success');
            }

            // Usar funci√≥n segura para guardar
            const saveSuccess = safeSetItem('savedQRs', savedQRs);
            if (!saveSuccess) {
                showMessage('‚ö†Ô∏è No se pudo guardar en el dispositivo. Verifica el almacenamiento.', 'warning');
            }
            
            loadSavedQRs();
            document.getElementById('qrTitle').value = '';
        }

        function loadSavedQRs() {
            const savedQRs = safeGetItem('savedQRs', []);
            displayQRs(savedQRs);
        }

        function displayQRs(qrs) {
            const grid = document.getElementById('savedQrsGrid');
            grid.innerHTML = '';

            if (qrs.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6b7280; padding: 2rem;">No hay c√≥digos QR guardados</p>';
                return;
            }

            qrs.forEach(qr => {
                const card = document.createElement('div');
                card.className = 'qr-card';
                
                const qrType = qr.type || 'static';
                const typeBadge = qrType === 'dynamic' ? 
                    '<span class="qr-type-badge dynamic">Din√°mico</span>' : 
                    '<span class="qr-type-badge static">Est√°tico</span>';
                
                // Verificar que imageData existe y no es null
                const imageSrc = qr.imageData || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==';
                
                card.innerHTML = `
                    <img src="${imageSrc}" alt="QR Code" onerror="this.style.display='none'">
                    <h4>${qr.name} ${typeBadge}</h4>
                    <p>${qr.originalUrl || qr.url || 'Sin URL'}</p>
                    <p><small>${new Date(qr.timestamp).toLocaleDateString('es-ES')}</small></p>
                    <div class="qr-actions">
                        <button class="btn btn-primary btn-small" onclick="editQR('${qr.id}')">
                            ‚úèÔ∏è Editar
                        </button>
                        ${qrType === 'dynamic' ? `
                            <button class="btn btn-secondary btn-small" onclick="manageDynamicQR('${qr.id}')">
                                ‚öôÔ∏è Gestionar
                            </button>
                        ` : ''}
                        <button class="btn btn-secondary btn-small" onclick="downloadSavedQR('${qr.id}')">
                            üíæ Descargar
                        </button>
                        <button class="btn btn-danger btn-small" onclick="deleteQR('${qr.id}')">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function filterQRs(type) {
            // Actualizar botones activos
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="filterQRs('${type}')"]`).classList.add('active');

            const savedQRs = safeGetItem('savedQRs', []);
            let filteredQRs = savedQRs;
            if (type !== 'all') {
                filteredQRs = savedQRs.filter(qr => (qr.type || 'static') === type);
            }
            
            displayQRs(filteredQRs);
        }

        // Funci√≥n para crear URL de QR din√°mico con par√°metros
        function createDynamicQRUrl(originalUrl, qrId, qrName) {
            // Si no es una URL v√°lida, agregar par√°metros al final
            const separator = originalUrl.includes('?') ? '&' : '?';
            return `${originalUrl}${separator}qr_id=${qrId}&qr_name=${encodeURIComponent(qrName)}`;
        }

        function manageDynamicQR(qrId) {
            const savedQRs = safeGetItem('savedQRs', []);
            const qr = savedQRs.find(q => q.id === qrId);
            if (!qr || qr.type !== 'dynamic') return;

            currentEditingQRId = qrId;
            document.getElementById('newUrl').value = qr.originalUrl || qr.url;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            currentEditingQRId = null;
        }

        function updateDynamicQR() {
            const newUrl = document.getElementById('newUrl').value.trim();
            if (!newUrl) {
                showMessage('Por favor ingresa una URL v√°lida', 'error');
                return;
            }

            let savedQRs = safeGetItem('savedQRs', []);
            const qrIndex = savedQRs.findIndex(q => q.id === currentEditingQRId);
            if (qrIndex !== -1) {
                const qr = savedQRs[qrIndex];
                
                // Actualizar la URL original
                savedQRs[qrIndex].originalUrl = newUrl;
                savedQRs[qrIndex].timestamp = new Date().toISOString();
                
                // Para QRs din√°micos, actualizar la URL de redirecci√≥n
                if (savedQRs[qrIndex].type === 'dynamic') {
                    // Crear la nueva URL de redirecci√≥n con par√°metros
                    const qrId = savedQRs[qrIndex].id;
                    const qrName = savedQRs[qrIndex].name;
                    const redirectUrl = createDynamicQRUrl(newUrl, qrId, qrName);
                    
                    // Actualizar las URLs
                    savedQRs[qrIndex].url = redirectUrl; // URL con par√°metros para el QR
                    savedQRs[qrIndex].redirectUrl = newUrl; // URL final de destino
                    
                    // Actualizar par√°metros codificados
                    savedQRs[qrIndex].encodedUrl = btoa(encodeURIComponent(newUrl));
                    savedQRs[qrIndex].encodedName = btoa(encodeURIComponent(qrName));
                    
                    // Regenerar el QR visual con la nueva URL
                    regenerateQRWithNewUrl(redirectUrl, qr, savedQRs, qrIndex);
                } else {
                    // Para QRs est√°ticos, solo actualizar la URL
                    savedQRs[qrIndex].url = newUrl;
                    
                    // Regenerar el QR visual con la nueva URL
                    regenerateQRWithNewUrl(newUrl, qr, savedQRs, qrIndex);
                }
            }
        }

        // Funci√≥n auxiliar para regenerar el QR visual con nueva URL
        function regenerateQRWithNewUrl(newUrl, qr, savedQRs, qrIndex) {
            // Configurar el canvas para generar el nuevo QR
            const canvas = document.createElement('canvas');
            canvas.width = qr.size || 300;
            canvas.height = qr.size || 300;
            
            // Opciones para generar el QR
            const options = {
                width: qr.size || 300,
                height: qr.size || 300,
                colorDark: qr.colors?.foreground || '#000000',
                colorLight: qr.colors?.background || '#FFFFFF',
                correctLevel: getErrorCorrectionLevel(qr.errorCorrection || 'M')
            };
            
            // Generar el nuevo QR
            QRCode.toCanvas(canvas, newUrl, options, function(error, generatedCanvas) {
                if (error) {
                    console.error('Error al regenerar QR:', error);
                    showMessage('Error al regenerar el QR visual: ' + error.message, 'error');
                    return;
                }
                
                // Aplicar colores personalizados
                colorizeQRCanvas(generatedCanvas, options.colorDark, options.colorLight);
                
                // Aplicar quiet zone si existe
                if (qr.quietZoneSize !== undefined && qr.quietZoneSize >= 0) {
                    applyQuietZoneToQR(generatedCanvas, qr.quietZoneSize, options.colorLight);
                }
                
                // Obtener la nueva imagen
                const newImageData = generatedCanvas.toDataURL('image/png');
                
                // Actualizar la imagen en el QR guardado
                savedQRs[qrIndex].imageData = newImageData;
                
                // Guardar los cambios
                const saveSuccess = safeSetItem('savedQRs', savedQRs);
                if (!saveSuccess) {
                    showMessage('‚ö†Ô∏è No se pudo guardar la actualizaci√≥n. Verifica el almacenamiento.', 'warning');
                } else {
                    showMessage('QR actualizado exitosamente. El c√≥digo QR ahora redirigir√° a la nueva URL.', 'success');
                }
                
                closeModal();
                loadSavedQRs();
            });
        }

        // Funci√≥n auxiliar para obtener el nivel de correcci√≥n de errores
        function getErrorCorrectionLevel(level) {
            switch(level) {
                case 'L': return 0;
                case 'M': return 1;
                case 'Q': return 2;
                case 'H': return 3;
                default: return 1;
            }
        }

        function editQR(qrId) {
            const savedQRs = safeGetItem('savedQRs', []);
            const qr = savedQRs.find(q => q.id === qrId);
            if (!qr) return;

            // Cargar datos en el formulario
            document.getElementById('qrType').value = qr.type || 'static';
            document.getElementById('qrUrl').value = qr.originalUrl || qr.url;
            document.getElementById('qrTitle').value = qr.name;
            document.getElementById('qrSize').value = qr.size || '300';
            document.getElementById('foregroundColor').value = qr.colors?.foreground || '#000000';
            document.getElementById('foregroundHex').value = qr.colors?.foreground || '#000000';
            document.getElementById('backgroundColor').value = qr.colors?.background || '#FFFFFF';
            document.getElementById('backgroundColorHex').value = qr.colors?.background || '#FFFFFF';
            document.getElementById('errorCorrection').value = qr.errorCorrection || 'M';

            // Cargar el QR existente en lugar de regenerarlo
            if (qr.imageData) {
                const container = document.getElementById('qrContainer');
                container.innerHTML = `<img src="${qr.imageData}" style="max-width: 100%; height: auto;">`;
                
                // Configurar datos del QR actual
                currentQRData = {
                    url: qr.originalUrl || qr.url,
                    qrType: qr.type || 'static',
                    title: qr.name,
                    size: qr.size || 300,
                    colors: qr.colors || { foreground: '#000000', background: '#FFFFFF' },
                    errorCorrection: qr.errorCorrection || 'M',
                    timestamp: qr.timestamp,
                    qrText: qr.originalUrl || qr.url,
                    isDemo: false
                };

                // Mostrar botones de acci√≥n
                document.getElementById('regenerateBtn').style.display = 'inline-flex';
                document.querySelector('.btn-primary').style.display = 'none';
                document.getElementById('saveChangesBtn').style.display = 'none';

                // Mostrar informaci√≥n del QR
                showQRInfo();
                
                showMessage('QR cargado para edici√≥n. Modifica los par√°metros y usa "Guardar Cambios" para actualizar.', 'success');
            } else {
                // Si no hay imagen guardada, generar el QR
                generateQR();
            }
        }

        function downloadSavedQR(qrId) {
            const savedQRs = safeGetItem('savedQRs', []);
            const qr = savedQRs.find(q => q.id === qrId);
            if (!qr) return;

            // Crear un enlace temporal para descargar
            const link = document.createElement('a');
            link.href = qr.dataUrl;
            link.download = `qr-${qr.name || 'codigo'}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('QR descargado exitosamente', 'success');
        }

        function deleteQR(qrId) {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este c√≥digo QR?')) {
                let savedQRs = safeGetItem('savedQRs', []);
                savedQRs = savedQRs.filter(q => q.id !== qrId);
                const saveSuccess = safeSetItem('savedQRs', savedQRs);
                if (!saveSuccess) {
                    showMessage('‚ö†Ô∏è No se pudo eliminar. Verifica el almacenamiento.', 'warning');
                } else {
                    showMessage('C√≥digo QR eliminado', 'success');
                }
                loadSavedQRs();
            }
        }

        function toggleUrlInput() {
            const qrType = document.getElementById('qrType').value;
            const urlInput = document.getElementById('qrUrl');
            const urlGroup = document.getElementById('urlInputGroup');
            
            if (qrType === 'dynamic') {
                urlInput.required = true;
                urlGroup.style.opacity = '1';
            } else {
                urlInput.required = true;
                urlGroup.style.opacity = '1';
            }
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showMessage(message, type) {
            const successMsg = document.getElementById('successMessage');
            const errorMsg = document.getElementById('errorMessage');
            
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            
            if (type === 'success') {
                successMsg.textContent = message;
                successMsg.style.display = 'block';
            } else {
                errorMsg.textContent = message;
                errorMsg.style.display = 'block';
            }
            
            setTimeout(() => {
                successMsg.style.display = 'none';
                errorMsg.style.display = 'none';
            }, 5000);
        }



        // Funcionalidad avanzada de colores
        function initializeColorPickers() {
            console.log('Inicializando color pickers...');
            
            const foregroundColorElement = document.getElementById('foregroundColor');
            const backgroundColorElement = document.getElementById('backgroundColor');
            
            if (foregroundColorElement) {
                foregroundColorElement.addEventListener('change', function() {
                    const hexValue = this.value.toUpperCase();
                    console.log('Color principal cambiado a:', hexValue);
                    document.getElementById('foregroundHex').value = hexValue;
                    // Actualizar colores del QR existente en lugar de regenerar
                    if (currentQRData && currentQRData.qrText) {
                        updateQRColors();
                    }
                });
            } else {
                console.error('Elemento foregroundColor no encontrado');
            }

            if (backgroundColorElement) {
                backgroundColorElement.addEventListener('change', function() {
                    const hexValue = this.value.toUpperCase();
                    console.log('Color de fondo cambiado a:', hexValue);
                    document.getElementById('backgroundColorHex').value = hexValue;
                    // Actualizar colores del QR existente en lugar de regenerar
                    if (currentQRData && currentQRData.qrText) {
                        updateQRColors();
                    }
                });
            } else {
                console.error('Elemento backgroundColor no encontrado');
            }

            // Event listeners para input de c√≥digo hex
            const foregroundHexElement = document.getElementById('foregroundHex');
            const backgroundColorHexElement = document.getElementById('backgroundColorHex');
            
            if (foregroundHexElement) {
                foregroundHexElement.addEventListener('input', function() {
                    let hexValue = this.value.toUpperCase();
                    if (hexValue.startsWith('#')) {
                        hexValue = hexValue.substring(1);
                    }
                    if (hexValue.length === 6 && /^[0-9A-F]{6}$/.test(hexValue)) {
                        hexValue = '#' + hexValue;
                        console.log('Color principal (hex) cambiado a:', hexValue);
                        document.getElementById('foregroundColor').value = hexValue;
                        // Actualizar colores del QR existente en lugar de regenerar
                        if (currentQRData && currentQRData.qrText) {
                            updateQRColors();
                        }
                    }
                });
            } else {
                console.error('Elemento foregroundHex no encontrado');
            }

            if (backgroundColorHexElement) {
                backgroundColorHexElement.addEventListener('input', function() {
                    let hexValue = this.value.toUpperCase();
                    if (hexValue.startsWith('#')) {
                        hexValue = hexValue.substring(1);
                    }
                    if (hexValue.length === 6 && /^[0-9A-F]{6}$/.test(hexValue)) {
                        hexValue = '#' + hexValue;
                        console.log('Color de fondo (hex) cambiado a:', hexValue);
                        document.getElementById('backgroundColor').value = hexValue;
                        // Actualizar colores del QR existente en lugar de regenerar
                        if (currentQRData && currentQRData.qrText) {
                            updateQRColors();
                        }
                    }
                });
            } else {
                console.error('Elemento backgroundColorHex no encontrado');
            }
        }

        // Funcionalidad de controles de quiet zone
        function initializeQuietZoneControls() {
            console.log('Inicializando controles de quiet zone...');
            
            const quietZoneSizeElement = document.getElementById('quietZoneSize');
            const quietZoneSizeValueElement = document.getElementById('quietZoneSizeValue');
            
            if (quietZoneSizeElement) {
                quietZoneSizeElement.addEventListener('input', function() {
                    const size = this.value;
                    console.log('Tama√±o de quiet zone cambiado a:', size + 'px');
                    quietZoneSizeValueElement.textContent = size + 'px';
                    // Actualizar colores del QR existente en lugar de regenerar
                    if (currentQRData && currentQRData.qrText) {
                        updateQRColors();
                    }
                });
            } else {
                console.error('Elemento quietZoneSize no encontrado');
            }
        }

        // Funci√≥n para colorear el canvas del QR
        function colorizeQRCanvas(canvas, foregroundColor, backgroundColor) {
            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Convertir colores hex a RGB
            const fg = hexToRgb(foregroundColor);
            const bg = hexToRgb(backgroundColor);
            
            console.log('Coloreando QR con:', { foreground: fg, background: bg });
            
            for (let i = 0; i < data.length; i += 4) {
                // Si el p√≠xel es negro (o muy oscuro), cambiarlo al color de primer plano
                if (data[i] < 128 && data[i+1] < 128 && data[i+2] < 128) {
                    data[i] = fg.r;     // R
                    data[i+1] = fg.g;   // G
                    data[i+2] = fg.b;   // B
                    data[i+3] = 255;    // A
                } else {
                    // Si el p√≠xel es blanco (o muy claro), cambiarlo al color de fondo
                    data[i] = bg.r;     // R
                    data[i+1] = bg.g;   // G
                    data[i+2] = bg.b;   // B
                    data[i+3] = 255;    // A
                }
            }
            
            ctx.putImageData(imageData, 0, 0);
            console.log('QR coloreado exitosamente');
        }
        
        // Funci√≥n auxiliar para convertir hex a RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 0, g: 0, b: 0 };
        }

        // Funci√≥n para aplicar quiet zone personalizado al QR
        function applyQuietZoneToQR(canvas, quietZoneSize, qrLightColor) {
            const ctx = canvas.getContext('2d');
            const originalWidth = canvas.width;
            const originalHeight = canvas.height;
            
            if (quietZoneSize <= 0) {
                // Si no hay espacio, el QR debe llenar completamente el canvas
                // Convertir qrLightColor a valores RGB
                let lightR, lightG, lightB;
                if (qrLightColor.startsWith('#')) {
                    const hex = qrLightColor.slice(1);
                    lightR = parseInt(hex.substring(0, 2), 16);
                    lightG = parseInt(hex.substring(2, 4), 16);
                    lightB = parseInt(hex.substring(4, 6), 16);
                } else if (qrLightColor.startsWith('rgb')) {
                    const rgb = qrLightColor.match(/\d+/g).map(Number);
                    lightR = rgb[0];
                    lightG = rgb[1];
                    lightB = rgb[2];
                } else {
                    lightR = 255; lightG = 255; lightB = 255;
                }
                
                // Obtener los datos de imagen actuales
                const imageData = ctx.getImageData(0, 0, originalWidth, originalHeight);
                const data = imageData.data;
                
                // Encontrar los l√≠mites del QR (d√≥nde empieza y termina el patr√≥n oscuro)
                let minX = originalWidth, minY = originalHeight, maxX = 0, maxY = 0;
                
                for (let y = 0; y < originalHeight; y++) {
                    for (let x = 0; x < originalWidth; x++) {
                        const index = (y * originalWidth + x) * 4;
                        // Si el p√≠xel NO es el color claro (es parte del patr√≥n oscuro)
                        if (!(data[index] === lightR && data[index + 1] === lightG && data[index + 2] === lightB)) {
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                    }
                }
                
                // Si no se encontraron p√≠xeles oscuros, retornar
                if (minX === originalWidth) {
                    console.log('No se encontraron p√≠xeles oscuros en el QR');
                    return;
                }
                
                // Calcular las dimensiones del QR real (solo el patr√≥n)
                const qrWidth = maxX - minX + 1;
                const qrHeight = maxY - minY + 1;
                
                // Crear un nuevo canvas del mismo tama√±o
                const newCanvas = document.createElement('canvas');
                newCanvas.width = originalWidth;
                newCanvas.height = originalHeight;
                const newCtx = newCanvas.getContext('2d');
                
                // Llenar todo el canvas con el color de fondo del QR
                newCtx.fillStyle = qrLightColor;
                newCtx.fillRect(0, 0, originalWidth, originalHeight);
                
                // Calcular el factor de escala para que el QR llene todo el canvas
                const scaleX = originalWidth / qrWidth;
                const scaleY = originalHeight / qrHeight;
                const scale = Math.min(scaleX, scaleY);
                
                // Calcular las nuevas dimensiones del QR expandido
                const scaledWidth = qrWidth * scale;
                const scaledHeight = qrHeight * scale;
                
                // Calcular la posici√≥n centrada
                const offsetX = (originalWidth - scaledWidth) / 2;
                const offsetY = (originalHeight - scaledHeight) / 2;
                
                // Crear un canvas temporal con solo el QR
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = qrWidth;
                tempCanvas.height = qrHeight;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Copiar solo la parte del QR al canvas temporal
                const qrImageData = ctx.getImageData(minX, minY, qrWidth, qrHeight);
                tempCtx.putImageData(qrImageData, 0, 0);
                
                // Dibujar el QR expandido en el nuevo canvas
                newCtx.drawImage(tempCanvas, offsetX, offsetY, scaledWidth, scaledHeight);
                
                // Reemplazar el canvas original
                ctx.clearRect(0, 0, originalWidth, originalHeight);
                ctx.drawImage(newCanvas, 0, 0);
                
                console.log('QR expandido para llenar todo el canvas con fondo de color claro');
                return;
            }
            
            // Para espacios muy peque√±os (1-5px), usar un enfoque m√°s sutil
            if (quietZoneSize <= 5) {
                // En lugar de agregar espacio, reducir ligeramente el QR para crear el efecto de "casi sin fondo"
                const reductionFactor = quietZoneSize / 5; // 0.2 para 1px, 0.4 para 2px, etc.
                const reduction = Math.floor(originalWidth * reductionFactor * 0.1); // M√°ximo 10% de reducci√≥n
                
                // Crear un nuevo canvas del mismo tama√±o
                const newCanvas = document.createElement('canvas');
                newCanvas.width = originalWidth;
                newCanvas.height = originalHeight;
                const newCtx = newCanvas.getContext('2d');
                
                // Llenar con el color de fondo del QR
                newCtx.fillStyle = qrLightColor;
                newCtx.fillRect(0, 0, originalWidth, originalHeight);
                
                // Dibujar el QR ligeramente m√°s peque√±o y centrado
                const newWidth = originalWidth - (reduction * 2);
                const newHeight = originalHeight - (reduction * 2);
                const offsetX = reduction;
                const offsetY = reduction;
                
                newCtx.drawImage(canvas, offsetX, offsetY, newWidth, newHeight);
                
                // Reemplazar el canvas original
                ctx.clearRect(0, 0, originalWidth, originalHeight);
                ctx.drawImage(newCanvas, 0, 0);
                
                console.log('Quiet zone sutil aplicado al QR:', { size: quietZoneSize, reduction });
                return;
            }
            
            // Para espacios m√°s grandes, usar el m√©todo tradicional
            // Crear un nuevo canvas con espacio para el quiet zone
            const newCanvas = document.createElement('canvas');
            newCanvas.width = originalWidth + (quietZoneSize * 2);
            newCanvas.height = originalHeight + (quietZoneSize * 2);
            const newCtx = newCanvas.getContext('2d');
            
            // Obtener el color de fondo actual del QR
            const imageData = ctx.getImageData(0, 0, 1, 1);
            const backgroundColor = `rgb(${imageData.data[0]}, ${imageData.data[1]}, ${imageData.data[2]})`;
            
            // Dibujar el fondo del quiet zone con el mismo color que el fondo del QR
            newCtx.fillStyle = backgroundColor;
            newCtx.fillRect(0, 0, newCanvas.width, newCanvas.height);
            
            // Copiar el QR original al centro del nuevo canvas
            newCtx.drawImage(canvas, quietZoneSize, quietZoneSize);
            
            // Reemplazar el canvas original con el nuevo
            canvas.width = newCanvas.width;
            canvas.height = newCanvas.height;
            ctx.drawImage(newCanvas, 0, 0);
            
            console.log('Quiet zone aplicado al QR:', { size: quietZoneSize });
        }

        // Funciones para el men√∫ m√≥vil y mejoras de UX
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            mobileMenu.classList.toggle('active');
            
            // Prevenir scroll del body cuando el men√∫ est√° abierto
            if (mobileMenu.classList.contains('active')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function showHelp() {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            
            modalTitle.textContent = 'Ayuda - Generador de C√≥digos QR';
            modalBody.innerHTML = `
                <div style="line-height: 1.6;">
                    <h3 style="color: #10b981; margin-bottom: 1rem;">¬øC√≥mo usar el generador?</h3>
                    
                    <h4 style="color: #374151; margin: 1.5rem 0 0.5rem 0;">üì± QR Est√°tico</h4>
                    <p>‚Ä¢ Enlace fijo que no se puede cambiar despu√©s de crear</p>
                    <p>‚Ä¢ Ideal para informaci√≥n permanente</p>
                    
                    <h4 style="color: #374151; margin: 1.5rem 0 0.5rem 0;">üîÑ QR Din√°mico</h4>
                    <p>‚Ä¢ Enlace modificable despu√©s de crear</p>
                    <p>‚Ä¢ Incluye estad√≠sticas de visitas</p>
                    <p>‚Ä¢ Perfecto para campa√±as y promociones</p>
                    
                    <h4 style="color: #374151; margin: 1.5rem 0 0.5rem 0;">üé® Personalizaci√≥n</h4>
                    <p>‚Ä¢ Cambia colores del QR y fondo</p>
                    <p>‚Ä¢ Ajusta el tama√±o del c√≥digo</p>
                    <p>‚Ä¢ Controla el margen (quiet zone)</p>
                    <p>‚Ä¢ Selecciona nivel de correcci√≥n de errores</p>
                    
                    <h4 style="color: #374151; margin: 1.5rem 0 0.5rem 0;">üíæ Almacenamiento</h4>
                    <p>‚Ä¢ Los c√≥digos se guardan autom√°ticamente</p>
                    <p>‚Ä¢ Accede a tus QRs guardados en cualquier momento</p>
                    <p>‚Ä¢ Descarga o elimina c√≥digos seg√∫n necesites</p>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        // Funci√≥n para mostrar/ocultar bot√≥n de scroll to top
        function handleScroll() {
            const scrollToTopBtn = document.getElementById('scrollToTop');
            if (window.pageYOffset > 300) {
                scrollToTopBtn.classList.add('show');
            } else {
                scrollToTopBtn.classList.remove('show');
            }
        }

        // Funci√≥n para cerrar men√∫ m√≥vil al hacer clic fuera
        function handleClickOutside(event) {
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            
            if (mobileMenu.classList.contains('active') && 
                !mobileMenu.contains(event.target) && 
                !mobileMenuBtn.contains(event.target)) {
                toggleMobileMenu();
            }
        }

        // Funci√≥n para manejar tecla Escape
        function handleKeyDown(event) {
            if (event.key === 'Escape') {
                const mobileMenu = document.getElementById('mobileMenu');
                const modal = document.getElementById('modal');
                
                if (mobileMenu.classList.contains('active')) {
                    toggleMobileMenu();
                }
                
                if (modal.style.display === 'flex') {
                    closeModal();
                }
            }
        }

        // Funci√≥n para mejorar la experiencia t√°ctil
        function addTouchSupport() {
            // Mejorar botones para dispositivos t√°ctiles
            const buttons = document.querySelectorAll('.btn, .header-btn, .filter-btn');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.95)';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.transform = '';
                });
            });
        }

        // Funci√≥n para optimizar rendimiento en m√≥viles
        function optimizeForMobile() {
            if (window.innerWidth <= 768) {
                // Reducir animaciones en m√≥viles para mejor rendimiento
                const style = document.createElement('style');
                style.textContent = `
                    @media (max-width: 768px) {
                        * {
                            transition-duration: 0.2s !important;
                        }
                        .form-section:hover, .qr-section:hover, .qr-card:hover {
                            transform: none !important;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Funci√≥n para obtener la imagen del QR del canvas
        function getQRImageData() {
            const qrContainer = document.getElementById('qrContainer');
            const canvas = qrContainer.querySelector('canvas');
            
            if (!canvas) {
                console.error('No se encontr√≥ canvas del QR');
                return null;
            }
            
            try {
                return canvas.toDataURL('image/png');
            } catch (error) {
                console.error('Error al obtener imagen del QR:', error);
                return null;
            }
        }
    </script>

    <!-- Script espec√≠fico para corregir fondo azul en computadora -->
    <script>
        // Solo ejecutar en desktop para corregir fondo azul
        (function() {
            function fixDesktopBackground() {
                // Solo en desktop (pantalla ancha)
                if (window.innerWidth > 768) {
                    console.log('üñ•Ô∏è Corrigiendo fondo en desktop...');
                    
                    // Corregir fondo azul en desktop de manera suave
                    if (document.body) {
                        const currentBg = window.getComputedStyle(document.body).background;
                        if (currentBg.includes('blue') || currentBg.includes('rgb(0, 0, 255)')) {
                            document.body.style.background = 'linear-gradient(135deg, #ffffff 0%, #f8fafc 100%)';
                            console.log('‚úÖ Fondo azul corregido en body');
                        }
                    }
                    
                    // Solo corregir elementos espec√≠ficos con fondo azul
                    const elementsWithBlue = document.querySelectorAll('*');
                    let correctedCount = 0;
                    elementsWithBlue.forEach(el => {
                        const style = window.getComputedStyle(el);
                        if (style.background === 'blue' || style.backgroundColor === 'blue') {
                            el.style.background = 'transparent';
                            el.style.backgroundColor = 'transparent';
                            correctedCount++;
                        }
                    });
                    
                    if (correctedCount > 0) {
                        console.log(`‚úÖ ${correctedCount} elementos azules corregidos`);
                    }
                }
            }
            
            // Ejecutar despu√©s de que la p√°gina est√© completamente cargada
            window.addEventListener('load', function() {
                setTimeout(fixDesktopBackground, 100);
            });
            
            // Tambi√©n ejecutar despu√©s de un tiempo adicional
            setTimeout(fixDesktopBackground, 1000);
        })();
    </script>
</body>
</html> 